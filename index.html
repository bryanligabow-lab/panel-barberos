<script>
document.addEventListener("DOMContentLoaded", () => {

  // ‚úÖ NO CAMBIAR: tu Web App Apps Script (/exec)
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxWpXdGqiPiAuNb7c3-IKjisDpXn_6phyEstoYb2wGWq8GyA32a0fqbuKBCmQsuohWC/exec";

  // ---------------------------
  // Helpers UI
  // ---------------------------
  const $ = (id)=>document.getElementById(id);

  const envBadge = $("envBadge");
  const statusGlobal = $("statusGlobal");

  const loginCard = $("loginCard");
  const dashCard = $("dashCard");

  const barberoSelect = $("barberoSelect");
  const pinInput = $("pinInput");
  const btnLogin = $("btnLogin");

  const btnRefresh = $("btnRefresh");
  const btnLogout = $("btnLogout");

  const reqList = $("reqList");
  const emptyState = $("emptyState");
  const pendingCount = $("pendingCount");

  function setEnv(text){ if(envBadge) envBadge.textContent = text; }

  function showStatus(msg, ok=true){
    if (!statusGlobal) return;
    statusGlobal.style.display = "block";
    statusGlobal.className = "statusBox " + (ok ? "statusOk" : "statusErr");
    statusGlobal.textContent = msg;
    setTimeout(()=>{ statusGlobal.style.display="none"; }, 4500);
  }

  function setLoggedUI(on){
    loginCard.style.display = on ? "none" : "block";
    dashCard.style.display = on ? "block" : "none";
    btnLogout.style.display = on ? "inline-flex" : "none";
  }

  // ---------------------------
  // JSONP helper (SIN CORS) ‚úÖ
  // ---------------------------
  function jsonp(params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const url = new URL(WEB_APP_URL);
      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, String(v)));
      url.searchParams.set("callback", cb);

      const s = document.createElement("script");
      s.src = url.toString();
      s.async = true;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout JSONP"));
      }, 12000);

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cb]; } catch(_) {}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cb] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("Error cargando JSONP")); };

      document.head.appendChild(s);
    });
  }

  // ---------------------------
  // Session (token)
  // ---------------------------
  const SESSION_KEY = "barber_session_v1";

  function getSession(){
    try { return JSON.parse(localStorage.getItem(SESSION_KEY) || "null"); }
    catch { return null; }
  }
  function setSession(s){ localStorage.setItem(SESSION_KEY, JSON.stringify(s)); }
  function clearSession(){ localStorage.removeItem(SESSION_KEY); }

  // ---------------------------
  // Load barbers (action=listBarbers)
  // ---------------------------
  async function loadBarbers(){
    try{
      setEnv("Conectando‚Ä¶");
      barberoSelect.innerHTML = `<option value="">Cargando barberos‚Ä¶</option>`;
      barberoSelect.disabled = true;

      const res = await jsonp({ action:"listBarbers" });

      if (!res || !res.ok) throw new Error(res?.error || "No responde listBarbers");

      const barbers = (res.barbers || []).filter(Boolean);

      if (!barbers.length){
        barberoSelect.innerHTML = `<option value="">No hay barberos activos</option>`;
      } else {
        barberoSelect.innerHTML =
          `<option value="">Selecciona‚Ä¶</option>` +
          barbers.map(b => `<option value="${String(b).replace(/"/g,'&quot;')}">${b}</option>`).join("");
      }

      barberoSelect.disabled = false;
      setEnv("Conectado ‚úÖ");
    } catch(e){
      console.error(e);
      barberoSelect.innerHTML = `<option value="">Error al cargar</option>`;
      barberoSelect.disabled = false;
      setEnv("Error ‚ùå");
      showStatus("No se pudo conectar al servidor (revisa doGet JSONP en Apps Script).", false);
    }
  }

  // ---------------------------
  // LOGIN (action=panelLogin)  ‚úÖ
  // ---------------------------
  async function login(){
    const barber = (barberoSelect.value || "").trim();
    const pin = (pinInput.value || "").trim();

    if (!barber || !pin){
      showStatus("Selecciona barbero y escribe tu PIN.", false);
      return;
    }

    btnLogin.disabled = true;
    btnLogin.textContent = "‚è≥ Verificando‚Ä¶";

    try{
      const res = await jsonp({ action:"panelLogin", barber, pin });

      if (!res || !res.ok) throw new Error(res?.error || "No se pudo iniciar sesi√≥n");

      setSession({ barber, token: res.token, ts: Date.now() });
      setLoggedUI(true);
      showStatus("Sesi√≥n iniciada ‚úÖ");
      await loadRequests();

    }catch(e){
      console.error(e);
      showStatus(e.message || "No se pudo iniciar sesi√≥n.", false);
    }finally{
      btnLogin.disabled = false;
      btnLogin.textContent = "‚úÖ Entrar";
    }
  }

  // ---------------------------
  // List requests (action=panelList) ‚úÖ
  // ---------------------------
  async function loadRequests(){
    const sess = getSession();
    if (!sess?.token || !sess?.barber) return;

    reqList.innerHTML = "";
    emptyState.style.display = "none";
    pendingCount.textContent = "0";

    btnRefresh.disabled = true;
    btnRefresh.textContent = "‚è≥ Actualizando‚Ä¶";

    try{
      const res = await jsonp({
        action: "panelList",
        token: sess.token,
        barber: sess.barber
      });

      if (!res || !res.ok) throw new Error(res?.error || "No se pudieron cargar solicitudes");

      const items = Array.isArray(res.items) ? res.items : [];
      pendingCount.textContent = String(items.length);

      if (!items.length){
        emptyState.style.display = "block";
        return;
      }

      items.forEach(renderRequest);

    }catch(e){
      console.error(e);
      showStatus(e.message || "No se pudieron cargar solicitudes.", false);
    }finally{
      btnRefresh.disabled = false;
      btnRefresh.textContent = "üîÑ Actualizar";
    }
  }

  function esc(s){ return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

  function statusChip(status){
    const st = String(status || "PENDIENTE").toUpperCase();
    if (st.includes("ACEPT")) return `<span class="chip accepted">ACEPTADA</span>`;
    if (st.includes("RECH")) return `<span class="chip rejected">RECHAZADA</span>`;
    return `<span class="chip pending">PENDIENTE</span>`;
  }

  function renderRequest(item){
    const div = document.createElement("div");
    div.className = "req";

    const fotos = Array.isArray(item.fotos) ? item.fotos : [];
    const fotosHtml = fotos.length
      ? `<div class="photos">${fotos.map((f,i)=>`
            <a class="photoLink" href="${esc(f.url)}" target="_blank" rel="noopener">üñºÔ∏è Foto ${i+1}</a>
         `).join("")}</div>`
      : `<div class="hint">Sin fotos adjuntas.</div>`;

    div.innerHTML = `
      <div class="reqTop">
        <div>
          <div class="reqTitle">üë§ ${esc(item.nombre)} <span class="muted" style="font-weight:800;">(${esc(item.id)})</span></div>
          <div class="muted" style="font-size:13px;margin-top:4px;">
            üìÖ ${esc(item.fecha)} ‚Ä¢ üïí ${esc(item.hora)} ‚Ä¢ üíà ${esc(item.barbero)}
          </div>
        </div>
        <div class="chips">
          ${statusChip(item.status)}
          <span class="chip">üíµ ${esc(item.pago || "-")} ‚Ä¢ $${esc(item.presupuesto || "-")}</span>
        </div>
      </div>

      <div class="reqBody">
        <div class="kv">
          <div><b>Celular:</b> ${esc(item.celular)}</div>
          <div><b>Email:</b> ${esc(item.email)}</div>
          <div style="margin-top:8px;"><b>Descripci√≥n:</b><br>${esc(item.descripcion)}</div>
          <div style="margin-top:10px;">${fotosHtml}</div>
        </div>

        <div>
          <div class="actions">
            <button class="btn ok" data-act="ACEPTAR">‚úÖ Aceptar</button>
            <button class="btn danger" data-act="RECHAZAR">‚õî Rechazar</button>
          </div>
          <div class="hint" style="margin-top:10px; text-align:right;">
            Al aceptar/rechazar se actualiza en Sheets y se dispara el flujo.
          </div>
        </div>
      </div>
    `;

    div.querySelectorAll("button[data-act]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const act = btn.getAttribute("data-act");
        await updateRequest(item.id, act);
      });
    });

    reqList.appendChild(div);
  }

  // ---------------------------
  // Update request (action=panelDecision) ‚úÖ
  // ---------------------------
  async function updateRequest(id, decision){
    const sess = getSession();
    if (!sess?.token) {
      showStatus("Sesi√≥n no v√°lida. Inicia sesi√≥n otra vez.", false);
      setLoggedUI(false);
      return;
    }

    if (!confirm(`¬øSeguro que deseas ${decision} esta solicitud?`)) return;

    try{
      const res = await jsonp({
        action: "panelDecision",
        token: sess.token,
        id,
        decision
      });

      if (!res || !res.ok) throw new Error(res?.error || "No se pudo actualizar");

      showStatus(`Solicitud ${decision} ‚úÖ`);
      await loadRequests();

    }catch(e){
      console.error(e);
      showStatus(e.message || "No se pudo actualizar.", false);
    }
  }

  // ---------------------------
  // Logout
  // ---------------------------
  function logout(){
    clearSession();
    setLoggedUI(false);
    pinInput.value = "";
    showStatus("Sesi√≥n cerrada.");
  }

  // Events
  btnLogin.addEventListener("click", login);
  btnRefresh.addEventListener("click", loadRequests);
  btnLogout.addEventListener("click", logout);

  pinInput.addEventListener("keydown", (e)=>{ if (e.key === "Enter") login(); });

  // Boot
  await loadBarbers();

  const sess = getSession();
  if (sess?.token && sess?.barber){
    setLoggedUI(true);
    await loadRequests();
  } else {
    setLoggedUI(false);
  }

});
</script>
