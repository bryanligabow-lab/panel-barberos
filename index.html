<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Barberos - Peluquer√≠a de Bryan</title>

  <style>
    :root{
      --bg:#07090d;
      --card:rgba(17,24,39,.82);
      --line:rgba(255,255,255,.12);
      --text:#F9FAFB;
      --muted:rgba(249,250,251,.70);

      --gold:#d4af37;
      --gold2:#b88a10;

      --ok:#22c55e;
      --err:#ef4444;

      --shadow:0 18px 60px rgba(0,0,0,.40);
      --radius:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    body{
      margin:0; min-height:100vh;
      background:var(--bg);
      color:var(--text);
      display:flex; justify-content:center;
      padding:18px;
      overflow-x:hidden;
    }

    /* Fondo premium + part√≠culas */
    .bgFX{
      position:fixed; inset:-80px;
      pointer-events:none;
      background:
        radial-gradient(1000px 700px at 18% 10%, rgba(212,175,55,.22), transparent 60%),
        radial-gradient(1000px 700px at 85% 18%, rgba(59,130,246,.12), transparent 60%),
        radial-gradient(900px 620px at 45% 95%, rgba(34,197,94,.10), transparent 60%);
      opacity:.96;
      animation: floatGlow 10s ease-in-out infinite alternate;
    }
    @keyframes floatGlow{
      0%{ transform: translate3d(0,0,0) scale(1); filter: blur(0px); }
      100%{ transform: translate3d(0,-16px,0) scale(1.03); filter: blur(1px); }
    }
    .sparkles{
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.55;
      background-image:
        radial-gradient(2px 2px at 20% 30%, rgba(212,175,55,.65), transparent 60%),
        radial-gradient(2px 2px at 70% 40%, rgba(255,255,255,.35), transparent 60%),
        radial-gradient(2px 2px at 55% 80%, rgba(59,130,246,.35), transparent 60%),
        radial-gradient(1.5px 1.5px at 35% 65%, rgba(34,197,94,.35), transparent 60%),
        radial-gradient(1.5px 1.5px at 82% 72%, rgba(212,175,55,.35), transparent 60%);
      animation: twinkle 5.5s ease-in-out infinite alternate;
    }
    @keyframes twinkle{
      from{ transform: translateY(0px); filter: blur(.2px); }
      to{ transform: translateY(-10px); filter: blur(.6px); }
    }

    .wrap{max-width:1080px;width:100%; position:relative; z-index:2}

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      backdrop-filter: blur(12px);
      margin-bottom:14px;
    }

    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:46px;height:46px;border-radius:14px;
      border:1px solid rgba(212,175,55,.40);
      background:rgba(255,255,255,.06);
      display:flex;align-items:center;justify-content:center;
      font-weight:1000;
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40px;
      background:linear-gradient(115deg, transparent 45%, rgba(212,175,55,.22) 50%, transparent 55%);
      transform: rotate(12deg) translateX(-60%);
      animation: shine 2.8s ease-in-out infinite;
    }
    @keyframes shine{
      0%{ transform: rotate(12deg) translateX(-70%); opacity:.0; }
      40%{ opacity:.55; }
      100%{ transform: rotate(12deg) translateX(70%); opacity:0; }
    }

    .badge{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(212,175,55,.28);
      background:rgba(212,175,55,.10);
      color:rgba(249,250,251,.92);
      user-select:none;
      white-space:nowrap;
    }

    .btn{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
      background:rgba(255,255,255,.04);
      color:var(--text);
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      transition: transform .08s ease, filter .2s ease, opacity .2s ease;
    }
    .btn:hover{ filter:brightness(1.08); }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .primary{
      background:linear-gradient(135deg,var(--gold),var(--gold2));
      color:#1a1406;
      border-color:rgba(212,175,55,.45);
      box-shadow:0 12px 30px rgba(212,175,55,.12);
    }
    .danger{
      background:rgba(239,68,68,.14);
      border-color:rgba(239,68,68,.35);
    }
    .ok{
      background:rgba(34,197,94,.14);
      border-color:rgba(34,197,94,.35);
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      align-items:start;
    }
    @media(max-width:980px){ .grid{grid-template-columns:1fr} }

    label{font-size:13px; display:block; margin-top:12px;}
    input,select,textarea{
      width:100%;
      margin-top:6px;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.25);
      color:white;
      outline:none;
    }

    .hint{font-size:12px;color:rgba(249,250,251,.65); margin-top:8px}
    .muted{color:var(--muted)}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}

    .list{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }

    .req{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:14px;
      animation: pop .25s ease;
    }
    @keyframes pop{
      from{ transform: translateY(6px); opacity:.0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .reqTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .reqTitle{font-weight:1000;font-size:15px}

    .chips{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .chip{
      font-size:12px; padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(249,250,251,.92);
    }
    .chip.pending{ border-color:rgba(212,175,55,.45); background:rgba(212,175,55,.10); }
    .chip.accepted{ border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12); }
    .chip.rejected{ border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12); }

    .reqBody{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
    }
    @media(max-width:880px){ .reqBody{grid-template-columns:1fr} }

    .kv{font-size:13px; line-height:1.5}
    .kv b{color:rgba(249,250,251,.92)}
    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }

    .photos{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .photoLink{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-weight:900;
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      color:rgba(249,250,251,.92);
      text-decoration:none;
    }

    .statusBox{
      display:none;
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      font-weight:900;
    }
    .statusOk{ border-color:rgba(34,197,94,.45); background:rgba(34,197,94,.12); }
    .statusErr{ border-color:rgba(239,68,68,.45); background:rgba(239,68,68,.12); }

    .loaderDot{
      display:inline-block;
      width:6px;height:6px;border-radius:50%;
      background:rgba(249,250,251,.78);
      margin-left:6px;
      animation: dot 1s ease-in-out infinite;
    }
    .loaderDot:nth-child(2){ animation-delay:.15s; opacity:.8; }
    .loaderDot:nth-child(3){ animation-delay:.3s; opacity:.6; }
    @keyframes dot{
      0%,100%{ transform: translateY(0px); }
      50%{ transform: translateY(-4px); }
    }
  </style>
</head>

<body>
  <div class="bgFX"></div>
  <div class="sparkles"></div>

  <div class="wrap">
    <!-- HEADER -->
    <div class="card">
      <div class="top">
        <div class="title">
          <div class="logo">üíà</div>
          <div>
            <div style="font-size:18px;font-weight:1000;">Panel de Barberos</div>
            <div class="muted" style="font-size:13px;">Ver y gestionar citas pendientes (Aceptar / Rechazar)</div>
          </div>
          <span id="envBadge" class="badge">Conectando<span class="loaderDot"></span><span class="loaderDot"></span><span class="loaderDot"></span></span>
        </div>

        <div class="actions">
          <button id="btnRefresh" class="btn">üîÑ Actualizar</button>
          <button id="btnLogout" class="btn danger" style="display:none;">üö™ Salir</button>
        </div>
      </div>

      <div id="statusGlobal" class="statusBox"></div>
    </div>

    <div class="grid">
      <!-- LOGIN -->
      <div class="card" id="loginCard">
        <div style="font-weight:1000;font-size:15px;">üîê Iniciar sesi√≥n</div>
        <div class="hint">Cada barbero entra con su <b>nombre</b> y su <b>PIN</b>.</div>

        <div class="divider"></div>

        <label>Barbero</label>
        <select id="barberoSelect">
          <option value="">Cargando barberos‚Ä¶</option>
        </select>

        <label>PIN / Contrase√±a</label>
        <input id="pinInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">

        <button id="btnLogin" class="btn primary" style="margin-top:14px; width:100%;">‚úÖ Entrar</button>

        <div class="hint">
          Si no aparece un barbero aqu√≠, revisa tu hoja <b>BARBEROS</b> (ACTIVO=SI).
        </div>
      </div>

      <!-- DASHBOARD -->
      <div class="card" id="dashCard" style="display:none;">
        <div class="top">
          <div>
            <div style="font-size:15px;font-weight:1000;">üìã Solicitudes pendientes</div>
            <div class="muted" style="font-size:13px;">Solo ver√°s las citas asignadas a tu nombre.</div>
          </div>
          <div class="chips">
            <span class="chip pending">Pendientes: <b id="pendingCount">0</b></span>
          </div>
        </div>

        <div class="divider"></div>

        <div id="reqList" class="list"></div>

        <div id="emptyState" class="muted" style="display:none; padding:14px 0;">
          No tienes solicitudes pendientes por ahora.
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ‚úÖ NO CAMBIAR: tu Web App Apps Script (el /exec)
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxWpXdGqiPiAuNb7c3-IKjisDpXn_6phyEstoYb2wGWq8GyA32a0fqbuKBCmQsuohWC/exec";

  // ---------------------------
  // UI helpers
  // ---------------------------
  const $ = (id)=>document.getElementById(id);

  const envBadge = $("envBadge");
  const statusGlobal = $("statusGlobal");

  const loginCard = $("loginCard");
  const dashCard = $("dashCard");

  const barberoSelect = $("barberoSelect");
  const pinInput = $("pinInput");
  const btnLogin = $("btnLogin");

  const btnRefresh = $("btnRefresh");
  const btnLogout = $("btnLogout");

  const reqList = $("reqList");
  const emptyState = $("emptyState");
  const pendingCount = $("pendingCount");

  function setEnv(text, ok=true){
    envBadge.textContent = text;
    envBadge.style.borderColor = ok ? "rgba(34,197,94,.35)" : "rgba(239,68,68,.35)";
    envBadge.style.background = ok ? "rgba(34,197,94,.12)" : "rgba(239,68,68,.12)";
  }

  function showStatus(msg, ok=true){
    statusGlobal.style.display = "block";
    statusGlobal.className = "statusBox " + (ok ? "statusOk" : "statusErr");
    statusGlobal.textContent = msg;
    setTimeout(()=>{ statusGlobal.style.display="none"; }, 4200);
  }

  function setLoggedUI(on){
    loginCard.style.display = on ? "none" : "block";
    dashCard.style.display = on ? "block" : "none";
    btnLogout.style.display = on ? "inline-flex" : "none";
  }

  // ---------------------------
  // Session storage
  // ---------------------------
  const SESSION_KEY = "barber_session_v1";

  function getSession(){
    try { return JSON.parse(localStorage.getItem(SESSION_KEY) || "null"); }
    catch { return null; }
  }
  function setSession(s){
    localStorage.setItem(SESSION_KEY, JSON.stringify(s));
  }
  function clearSession(){
    localStorage.removeItem(SESSION_KEY);
  }

  // ---------------------------
  // Escape helper
  // ---------------------------
  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // ---------------------------
  // JSONP API (SIN CORS)
  // Requiere que Apps Script acepte GET con ?callback=xxx
  // ---------------------------
  function jsonp(params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const url = new URL(WEB_APP_URL);

      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, String(v)));
      url.searchParams.set("callback", cb);

      const s = document.createElement("script");
      s.src = url.toString();
      s.async = true;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout JSONP"));
      }, 12000);

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cb]; } catch {}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cb] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("Error cargando JSONP")); };

      document.head.appendChild(s);
    });
  }

  // ---------------------------
  // Cargar barberos
  // action: listBarbers
  // ---------------------------
  async function loadBarbers(){
    try{
      setEnv("Conectando‚Ä¶", true);
      barberoSelect.innerHTML = `<option value="">Cargando barberos‚Ä¶</option>`;
      barberoSelect.disabled = true;

      const res = await jsonp({ action:"listBarbers" });

      if (!res || !res.ok) throw new Error(res?.error || "No responde listBarbers");

      const barbers = (res.barbers || []).filter(Boolean);

      if (!barbers.length){
        barberoSelect.innerHTML = `<option value="">No hay barberos activos</option>`;
      } else {
        barberoSelect.innerHTML =
          `<option value="">Selecciona‚Ä¶</option>` +
          barbers.map(b => `<option value="${esc(b)}">${esc(b)}</option>`).join("");
      }

      barberoSelect.disabled = false;
      setEnv("Conectado ‚úÖ", true);
    }catch(e){
      console.error(e);
      setEnv("Sin conexi√≥n ‚ùå", false);
      barberoSelect.innerHTML = `<option value="">Error al cargar</option>`;
      barberoSelect.disabled = false;
      showStatus("No se pudo cargar BARBEROS. (Revisar Apps Script / doGet JSONP)", false);
    }
  }

  // ---------------------------
  // LOGIN
  // action: barberLogin
  // ---------------------------
  async function login(){
    const barber = (barberoSelect.value || "").trim();
    const pin = (pinInput.value || "").trim();

    if (!barber || !pin){
      showStatus("Selecciona barbero y escribe tu PIN.", false);
      return;
    }

    btnLogin.disabled = true;
    btnLogin.textContent = "‚è≥ Verificando‚Ä¶";

    try{
      const res = await jsonp({ action:"barberLogin", barber, pin });

      if (!res || !res.ok) throw new Error(res?.error || "No se pudo iniciar sesi√≥n");

      setSession({ barber, token: res.token, ts: Date.now() });
      setLoggedUI(true);
      showStatus("Sesi√≥n iniciada ‚úÖ", true);
      await loadRequests();

    }catch(e){
      console.error(e);
      showStatus(e.message || "Error de login", false);
    }finally{
      btnLogin.disabled = false;
      btnLogin.textContent = "‚úÖ Entrar";
    }
  }

  // ---------------------------
  // Listar pendientes
  // action: barberListRequests
  // ---------------------------
  async function loadRequests(){
    const sess = getSession();
    if (!sess?.token || !sess?.barber){
      setLoggedUI(false);
      return;
    }

    reqList.innerHTML = "";
    emptyState.style.display = "none";
    pendingCount.textContent = "0";

    btnRefresh.disabled = true;
    btnRefresh.textContent = "‚è≥ Actualizando‚Ä¶";

    try{
      const res = await jsonp({
        action: "barberListRequests",
        token: sess.token,
        barber: sess.barber
      });

      if (!res || !res.ok) throw new Error(res?.error || "No se pudieron cargar solicitudes");

      const items = Array.isArray(res.items) ? res.items : [];
      pendingCount.textContent = String(items.length);

      if (!items.length){
        emptyState.style.display = "block";
        return;
      }

      items.forEach(renderRequest);

    }catch(e){
      console.error(e);
      showStatus(e.message || "Error cargando solicitudes", false);
      // si token inv√°lido, vuelve a login
      if ((e.message || "").toLowerCase().includes("token")){
        clearSession();
        setLoggedUI(false);
      }
    }finally{
      btnRefresh.disabled = false;
      btnRefresh.textContent = "üîÑ Actualizar";
    }
  }

  function statusChip(status){
    const st = String(status || "PENDIENTE").toUpperCase();
    if (st.includes("ACEPT")) return `<span class="chip accepted">ACEPTADA</span>`;
    if (st.includes("RECH")) return `<span class="chip rejected">RECHAZADA</span>`;
    return `<span class="chip pending">PENDIENTE</span>`;
  }

  function renderRequest(item){
    const div = document.createElement("div");
    div.className = "req";

    const fotos = Array.isArray(item.fotos) ? item.fotos : [];
    const fotosHtml = fotos.length
      ? `<div class="photos">${fotos.map((f,i)=>`
            <a class="photoLink" href="${esc(f.url)}" target="_blank" rel="noopener">üñºÔ∏è Foto ${i+1}</a>
         `).join("")}</div>`
      : `<div class="hint">Sin fotos adjuntas.</div>`;

    div.innerHTML = `
      <div class="reqTop">
        <div>
          <div class="reqTitle">üë§ ${esc(item.nombre)} <span class="muted" style="font-weight:800;">(${esc(item.id)})</span></div>
          <div class="muted" style="font-size:13px;margin-top:4px;">
            üìÖ ${esc(item.fecha)} ‚Ä¢ üïí ${esc(item.hora)} ‚Ä¢ üíà ${esc(item.barbero)}
          </div>
        </div>
        <div class="chips">
          ${statusChip(item.status)}
          <span class="chip">üíµ ${esc(item.pago || "-")} ‚Ä¢ $${esc(item.presupuesto || "-")}</span>
        </div>
      </div>

      <div class="reqBody">
        <div class="kv">
          <div><b>Celular:</b> ${esc(item.celular)}</div>
          <div><b>Email:</b> ${esc(item.email)}</div>
          <div style="margin-top:8px;"><b>Descripci√≥n:</b><br>${esc(item.descripcion)}</div>
          <div style="margin-top:10px;">${fotosHtml}</div>
        </div>

        <div>
          <div class="actions">
            <button class="btn ok" data-act="ACEPTAR">‚úÖ Aceptar</button>
            <button class="btn danger" data-act="RECHAZAR">‚õî Rechazar</button>
          </div>
          <div class="hint" style="margin-top:10px; text-align:right;">
            Al aceptar/rechazar se actualiza en Sheets y se dispara tu flujo.
          </div>
        </div>
      </div>
    `;

    div.querySelectorAll("button[data-act]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const act = btn.getAttribute("data-act");
        await updateRequest(item.id, act);
      });
    });

    reqList.appendChild(div);
  }

  // ---------------------------
  // Aceptar/Rechazar
  // action: barberUpdateRequest
  // ---------------------------
  async function updateRequest(id, decision){
    const sess = getSession();
    if (!sess?.token){
      showStatus("Sesi√≥n no v√°lida. Inicia sesi√≥n otra vez.", false);
      setLoggedUI(false);
      return;
    }

    if (!confirm(`¬øSeguro que deseas ${decision} esta solicitud?`)) return;

    try{
      const res = await jsonp({
        action: "barberUpdateRequest",
        token: sess.token,
        id,
        decision // "ACEPTAR" | "RECHAZAR"
      });

      if (!res || !res.ok) throw new Error(res?.error || "No se pudo actualizar");

      showStatus(`Solicitud ${decision} ‚úÖ`, true);
      await loadRequests();

    }catch(e){
      console.error(e);
      showStatus(e.message || "Error actualizando", false);
    }
  }

  // ---------------------------
  // Logout
  // ---------------------------
  function logout(){
    clearSession();
    setLoggedUI(false);
    pinInput.value = "";
    showStatus("Sesi√≥n cerrada.");
  }

  // Eventos
  btnLogin.addEventListener("click", login);
  btnRefresh.addEventListener("click", loadRequests);
  btnLogout.addEventListener("click", logout);

  pinInput.addEventListener("keydown", (e)=>{
    if (e.key === "Enter") login();
  });

  // Boot
  (async () => {
    await loadBarbers();

    const sess = getSession();
    if (sess?.token && sess?.barber){
      setLoggedUI(true);
      await loadRequests();
    } else {
      setLoggedUI(false);
    }
  })();

});
</script>

</body>
</html>
