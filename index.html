<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Barberos - Peluquer√≠a de Bryan</title>
  <style>
    :root{
      --bg:#07090d; --card:rgba(17,24,39,.82); --line:rgba(255,255,255,.12);
      --text:#F9FAFB; --muted:rgba(249,250,251,.70);
      --gold:#d4af37; --gold2:#b88a10; --ok:#22c55e; --err:#ef4444;
      --shadow:0 18px 60px rgba(0,0,0,.40); --radius:18px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}
    body{margin:0;min-height:100vh;background:var(--bg);color:var(--text);display:flex;justify-content:center;padding:18px}
    .wrap{max-width:1080px;width:100%}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);margin-bottom:14px}
    .top{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .title{display:flex;gap:10px;align-items:center}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(212,175,55,.28);background:rgba(212,175,55,.10)}
    .btn{border:1px solid var(--line);border-radius:14px;padding:10px 12px;font-weight:900;cursor:pointer;background:rgba(255,255,255,.04);color:var(--text)}
    .primary{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#1a1406;border-color:rgba(212,175,55,.45)}
    .danger{background:rgba(239,68,68,.14);border-color:rgba(239,68,68,.35)}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:14px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    label{font-size:13px;display:block;margin-top:12px}
    input,select{width:100%;margin-top:6px;padding:10px 11px;border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:white;outline:none}
    .hint{font-size:12px;color:rgba(249,250,251,.65);margin-top:8px}
    .divider{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .statusBox{display:none;margin-top:10px;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);font-weight:900}
    .statusOk{border-color:rgba(34,197,94,.45);background:rgba(34,197,94,.12)}
    .statusErr{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div class="title">
          <div style="width:44px;height:44px;border-radius:14px;border:1px solid rgba(212,175,55,.40);display:flex;align-items:center;justify-content:center;font-weight:1000;">üíà</div>
          <div>
            <div style="font-size:18px;font-weight:1000;">Panel de Barberos</div>
            <div style="opacity:.75;font-size:13px;">Cargar barberos desde Sheets (BARBEROS)</div>
          </div>
          <span id="envBadge" class="badge">Conectando‚Ä¶</span>
        </div>
        <button id="btnRefresh" class="btn">üîÑ Actualizar</button>
      </div>
      <div id="statusGlobal" class="statusBox"></div>
    </div>

    <div class="grid">
      <div class="card">
        <div style="font-weight:1000;font-size:15px;">üîê Iniciar sesi√≥n</div>
        <div class="hint">Por ahora solo cargamos la lista de barberos (JSONP). Luego activamos login/panel.</div>

        <div class="divider"></div>

        <label>Barbero</label>
        <select id="barberoSelect">
          <option value="">Cargando barberos‚Ä¶</option>
        </select>

        <label>PIN / Contrase√±a</label>
        <input id="pinInput" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">

        <button class="btn primary" style="margin-top:14px;width:100%;" disabled>‚úÖ Entrar (pr√≥ximo paso)</button>

        <div class="hint">Si no aparece, revisa tu hoja <b>BARBEROS</b> (ACTIVO=SI).</div>
      </div>

      <div class="card">
        <div style="font-weight:1000;font-size:15px;">üìã Estado</div>
        <div class="hint">Cuando veas barberos, ya est√° bien conectada la WebApp con GitHub.</div>
      </div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // ‚úÖ TU WEB APP /exec
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxWpXdGqiPiAuNb7c3-IKjisDpXn_6phyEstoYb2wGWq8GyA32a0fqbuKBCmQsuohWC/exec";

  const $ = (id)=>document.getElementById(id);
  const envBadge = $("envBadge");
  const statusGlobal = $("statusGlobal");
  const barberoSelect = $("barberoSelect");
  const btnRefresh = $("btnRefresh");

  function showStatus(msg, ok=true){
    statusGlobal.style.display = "block";
    statusGlobal.className = "statusBox " + (ok ? "statusOk" : "statusErr");
    statusGlobal.textContent = msg;
    setTimeout(()=>{ statusGlobal.style.display="none"; }, 4500);
  }

  // JSONP helper
  function jsonp(params){
    return new Promise((resolve, reject) => {
      const cb = "cb_" + Math.random().toString(36).slice(2);
      const url = new URL(WEB_APP_URL);
      Object.entries(params || {}).forEach(([k,v]) => url.searchParams.set(k, String(v)));
      url.searchParams.set("callback", cb);

      const s = document.createElement("script");
      s.src = url.toString();
      s.async = true;

      const timeout = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout JSONP"));
      }, 12000);

      function cleanup(){
        clearTimeout(timeout);
        try { delete window[cb]; } catch(e){}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cb] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("Error cargando JSONP")); };

      document.head.appendChild(s);
    });
  }

  async function loadBarbers(){
    try{
      envBadge.textContent = "Conectando‚Ä¶";
      barberoSelect.innerHTML = `<option value="">Cargando barberos‚Ä¶</option>`;
      barberoSelect.disabled = true;

      const res = await jsonp({ action:"listBarbers" });

      if (!res || !res.ok) throw new Error(res?.error || "No responde listBarbers");

      const barbers = (res.barbers || []).filter(Boolean);

      if (!barbers.length) {
        barberoSelect.innerHTML = `<option value="">No hay barberos activos</option>`;
        showStatus("Conect√≥, pero no hay barberos ACTIVO=SI.", false);
      } else {
        barberoSelect.innerHTML =
          `<option value="">Selecciona‚Ä¶</option>` +
          barbers.map(b => `<option value="${String(b).replace(/"/g,'&quot;')}">${b}</option>`).join("");
        showStatus("Barberos cargados ‚úÖ", true);
      }

      barberoSelect.disabled = false;
      envBadge.textContent = "Conectado ‚úÖ";

    }catch(e){
      console.error(e);
      envBadge.textContent = "Sin conexi√≥n ‚ùå";
      barberoSelect.innerHTML = `<option value="">Error al cargar</option>`;
      barberoSelect.disabled = false;
      showStatus("No se pudo cargar barberos. Revisa Deploy y doGet √∫nico.", false);
    }
  }

  btnRefresh.addEventListener("click", loadBarbers);
  loadBarbers();
});
</script>
</body>
</html>
